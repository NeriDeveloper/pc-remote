<!DOCTYPE html>
<html>
<head>
    <title>Remote Control</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
      body {
        padding: 0;
        margin: 0;
      }

      #control-surface {
        float: left;
        background-color: #123123;
        width: calc(100% - 70px);
        height: 100vh;
      }

      #scroll-surface {
        float: left;
        background-color: #984193;
        width: 70px;
        height: 100vh;
      }
    </style>
</head>

<body>
  <div>
    <div touch-action="none" id="scroll-surface"></div>
    <div touch-action="none" id="control-surface"></div>
  </div>
  <script src="/vendors/jqueryPEP/pep.min.js"></script>
  <script src="/vendors/lodash/lodash.min.js"></script>
  <script src="/vendors/socket.io/socket.io-1.4.5.js"></script>
  <script>
    'use strict';

    var socket = io();
    var surface = document.getElementById('control-surface');
    var scroll = document.getElementById('scroll-surface');

    (function(){
      var previous = {
        pageX: 0,
        pageY: 0
      };
      var diff = {
        pageX: 0,
        pageY: 0
      };

      var isTouching = false;
      var isMoving = false;
      var firstTouch = {};

      surface.addEventListener('pointerdown', function(event) {
        previous.pageX = event.pageX;
        previous.pageY = event.pageY;

        firstTouch.pageX = event.pageX;
        firstTouch.pageY = event.pageY;

        isTouching = true;
      });

      surface.addEventListener('pointermove', function(event) {
        isMoving = true;
        if (isTouching) {
          event.preventDefault();
          diff.pageX = event.pageX - previous.pageX;
          diff.pageY = event.pageY - previous.pageY;
          previous.pageX = event.pageX;
          previous.pageY = event.pageY;

          socket.emit('key', 'mousemove', diff);
        }
      });

      surface.addEventListener('pointerup', function(event) {

        let travel = {
          pageX: event.pageX - firstTouch.pageX,
          pageY: event.pageY - firstTouch.pageY
        };
        let magnitude = Math.sqrt((travel.pageX * travel.pageX) + (travel.pageY * travel.pageY));
        if (magnitude < 50) {
          socket.emit('key', 'mousedown', { pageX: event.pageX, pageY: event.pageY });
        } else {
          socket.emit('key', 'navigatemove', travel);
        }

        isTouching = false;
        isMoving = false;
      });

    }());

    (function(){
      var previous = {
        pageX: 0,
        pageY: 0
      };
      var diff = {
        pageX: 0,
        pageY: 0
      };

      var isTouching = false;

      scroll.addEventListener('pointerdown', function(event) {
        previous.pageX = event.pageX;
        previous.pageY = event.pageY;

        isTouching = true;
      });

      scroll.addEventListener('pointermove', _.throttle(scrollPage, 10 * 4));

      scroll.addEventListener('pointerup', function(event) {
        isTouching = false;
      });

      function scrollPage(event) {
        if (isTouching) {
          event.preventDefault();
          diff.pageX = event.pageX - previous.pageX;
          diff.pageY = event.pageY - previous.pageY;
          previous.pageX = event.pageX;
          previous.pageY = event.pageY;

          socket.emit('key', 'scroll', diff);
        }
      }

    }());

  </script>
</body>
</html>
